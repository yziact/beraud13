<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <record id="beraud_parc_machine_form" model="ir.ui.view">
        <field name="name">Parc machine</field>
        <field name="model">parc_machine</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <div class="oe_button_box" name="button_box">

                        <button name="action_issue" type="object"  class="oe_stat_button"  icon="fa-bug">
                            <div class="o_form_field o_stat_info">
                                <label for="count_issue_tot" string="Incidents"/>
                                <span class="o_stat_value">
                                    <field name="count_issue_act" widget="integer" />
                                    (<field name="count_issue_tot" widget="integer" />)
                                </span>
                            </div>
                        </button>

                        <button name="action_repair" type="object"  class="oe_stat_button"  icon="fa-wrench">
                            <div class="o_form_field o_stat_info">
                                <label for="count_repair_tot" string="Interventions"/>
                                <span class="o_stat_value">
                                    <field name="count_repair_tot" widget="integer"/>
                                </span>
                            </div>
                        </button>
                    </div>
                    <group>
                        <group>
                            <field name="partner_id"  context="{'show_address': 1}" options="{&quot;always_reload&quot;: True}"/>
                            <field name="product_id"/>
                            <field name="lot_id"   context="{'default_product_id': product_id}"/>
                            <field name="quantity" invisible="1"/>
                        </group>
                        <group>
                            <field name="cm"/>
                            <field name="company_id"/>
                            <field name="date_prod"/>
                            <field name="date_guarantee"/>
                        </group>
                    </group>
                    <group>
                        <field name="location_partner"  context="{'show_address': 1}" options="{&quot;always_reload&quot;: True}"/>
                        <field name="quant_id" groups="base.group_no_one"/>
                        <field name="location_id" groups="base.group_no_one"/>
                    </group>
                    <group>
                        <field name="comments"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="beraud_parc_machine_tree" model="ir.ui.view">
        <field name="name">Parc machine tree</field>
        <field name="model">parc_machine</field>
        <field name="arch" type="xml">
            <tree>
                <field name="partner_id"/>
                <field name="product_id"/>
                <field name="company_id"/>
                <field name="lot_id"/>
                <field name="date_prod"/>
                <field name="date_guarantee"/>
                <field name="location_partner" context="{'show_address': 1}" options="{&quot;always_reload&quot;: True}"/>
                <field name="cm"/>
                <field name="quantity" sum="Total"/>
            </tree>
        </field>
    </record>

    <record model="ir.ui.view" id="parc_machine_search_view">
        <field name="name">Recherche Parc Machine</field>
        <field name="model">parc_machine</field>
        <field name="arch" type="xml">
            <search>
                <field name="partner_id"/>
                <field name="product_id"/>
                <field name="company_id"/>
                <field name="lot_id"/>
                <field name="date_prod"/>
                <field name="date_guarantee"/>
                <field name="location_partner" context="{'show_address': 1}" options="{&quot;always_reload&quot;: True}"/>
                <field name="cm"/>

                <field name="quant_id" groups="base.group_no_one"/>
                <field name="location_id" groups="base.group_no_one"/>

                <filter name="Sous contrat" string="Mes Actions" domain="[('cm','=', True)]"/>
                <filter string="Mise en prod ce mois" name="current_month" domain="[('date_prod','&lt;',(context_today()+relativedelta(months=1)).strftime('%%Y-%%m-01')), ('date_prod','>=',time.strftime('%%Y-%%m-01'))]"/>

                <group string="regrouper par :" name="group_by">
                    <filter name="group_by_company" string="Société" context="{'group_by': 'company_id'}"/>
                    <filter name="group_by_client" string="Client" context="{'group_by': 'partner_id'}"/>
                    <filter name="group_by_date" string="Date" context="{'group_by': 'date_prod'}"/>
                    <filter name="group_by_cm" string="CM" context="{'group_by': 'cm'}"/>
                </group>

            </search>
        </field>
    </record>

    <record id="beraud_parc_machine_action" model="ir.actions.act_window">
        <field name="name">Parc Machine</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">parc_machine</field>
        <field name="view_mode">tree,form</field>
        <field name="view_type">form</field>
        <field name="search_view_id" ref="beraud.parc_machine_search_view"/>

    </record>

    <!-- This Menu Item must have a parent and an action -->
    <!--<menuitem id="parc_beraud_machine" name="Parc Machines" parent="base.menu_board_root" action="beraud_parc_machine_action"/>-->
    <menuitem id="parc_beraud_machine" name="Parc Machines" web_icon="beraud,static/description/icon.png" action="beraud_parc_machine_action"/>

    <!-- LAISON INCIDENT -->
    <!--<record id="beraud_parc_machine_incident_kanban" model="ir.ui.view">
        <field name="name">Incidents Kanban</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="project_issue.project_issue_kanban_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='user_id']" position="after">
                <field name="product_id" groups="no_one"/>
                <field name="lot_id" groups="no_one"/>
            </xpath>

        </field>
    </record>-->

    <!-- Inherit Form View to Modify it -->
    <record id="beraud_parc_machine_incident_form" model="ir.ui.view">
        <field name="name">Incidents</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="project_issue.project_issue_form_view"/>
        <field name="arch" type="xml">

            <xpath expr="//field[@name='tag_ids']" position="after">
                <field name="product_id" options="{'no_create': True}"/>
                <field name="lot_id" context="{'default_product_id': product_id}" options="{'no_create': True}"/>
                <field name="parc_rec" options="{'no_create': True}" domain="[('product_id','=',product_id),('lot_id','=',lot_id)]"/>
            </xpath>

        </field>
    </record>

    <record id="beraud_parc_issue_filter" model="ir.ui.view">
        <field name="name">Project Issue Tracker Search</field>
        <field name="model">project.issue</field>
        <field name="inherit_id" ref="project_issue.view_project_issue_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='stage_id']" position="after">
                <field name="parc_rec" />
                <field name="lot_id" />
                <field name="product_id" />
            </xpath>
        </field>
    </record>

    <!-- Inherit Form View to Modify it -->
    <record id="beraud_parc_mmachine_repair_form" model="ir.ui.view">
        <field name="name">Interventions</field>
        <field name="model">mrp.repair</field>
        <field name="inherit_id" ref="mrp_repair.view_repair_order_form"/>
        <field name="arch" type="xml">

            <xpath expr="//field[@name='lot_id']" position="after">
                <field name="parc_rec"/>
            </xpath>

        </field>
    </record>

    <record id="beraud_parc_repair_filter" model="ir.ui.view">
        <field name="name">Repair Search</field>
        <field name="model">mrp.repair</field>
        <field name="inherit_id" ref="mrp_repair.view_repair_order_form_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="parc_rec" />
                <field name="lot_id" />
                <field name="address_id"/>
            </xpath>
            <xpath expr="//field[@name='partner_id']" position="replace">
            </xpath>
            <xpath expr="//field[@name='name']" position="before">
                 <field name="partner_id" filter_domain="[('partner_id', 'child_of', self)]"/>
            </xpath>
        </field>
    </record>

</odoo>
